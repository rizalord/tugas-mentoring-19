<!DOCTYPE html>
<html lang="en">

<head>
  <base href="./">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <meta name="description" content="CoreUI - Open Source Bootstrap Admin Template">
  <meta name="author" content="Ahmad Rizal Khamdani">
  <meta name="keyword" content="Bootstrap,Admin,Template,Open,Source,jQuery,CSS,HTML,RWD,Dashboard">
  <title>Tugas Mentoring 19</title>
  <meta name="theme-color" content="#ffffff">
  <!-- Vendors styles-->
  <link rel="stylesheet" href="vendors/simplebar/css/simplebar.css">
  <link rel="stylesheet" href="css/vendors/simplebar.css">
  <!-- Main styles for this application-->
  <link href="css/style.css" rel="stylesheet">
  <!-- Datatables -->
  <link href="https://cdn.datatables.net/v/bs5/jq-3.7.0/dt-1.13.6/r-2.5.0/datatables.min.css" rel="stylesheet">
  <script src="https://cdn.datatables.net/v/bs5/jq-3.7.0/dt-1.13.6/r-2.5.0/datatables.min.js"></script>
</head>

<body>
  <div class="sidebar sidebar-dark sidebar-fixed" id="sidebar">
    <div class="sidebar-brand d-none d-md-flex">
      <svg class="sidebar-brand-full" width="118" height="46" alt="CoreUI Logo">
        <use xlink:href="assets/brand/coreui.svg#full"></use>
      </svg>
      <svg class="sidebar-brand-narrow" width="46" height="46" alt="CoreUI Logo">
        <use xlink:href="assets/brand/coreui.svg#signet"></use>
      </svg>
    </div>
    <ul class="sidebar-nav" data-coreui="navigation" data-simplebar="">
      <li class="nav-item"><a class="nav-link" href="index.html">
          <svg class="nav-icon">
            <use xlink:href="vendors/@coreui/icons/svg/free.svg#cil-speedometer"></use>
          </svg> Dashboard</a></li>
    </ul>
    <button class="sidebar-toggler" type="button" data-coreui-toggle="unfoldable"></button>
  </div>
  <div class="wrapper d-flex flex-column min-vh-100 bg-light">
    <header class="header header-sticky mb-4">
      <div class="container-fluid">
        <button class="header-toggler px-md-0 me-md-3" type="button"
          onclick="coreui.Sidebar.getInstance(document.querySelector('#sidebar')).toggle()">
          <svg class="icon icon-lg">
            <use xlink:href="vendors/@coreui/icons/svg/free.svg#cil-menu"></use>
          </svg>
        </button><a class="header-brand d-md-none" href="#">
          <svg width="118" height="46" alt="CoreUI Logo">
            <use xlink:href="assets/brand/coreui.svg#full"></use>
          </svg></a>
        <ul class="header-nav d-none d-md-flex">
        </ul>
        <ul class="header-nav ms-auto">
        </ul>
        <ul class="header-nav ms-3">
          <li class="nav-item dropdown">
            <a class="nav-link py-0" data-coreui-toggle="dropdown" href="#" role="button" aria-haspopup="true"
              aria-expanded="false">
              <div class="avatar avatar-md"><img class="avatar-img" src="assets/img/avatars/me.jpeg"
                  alt="ahmadkhamdani9@email.com"></div>
            </a>
          </li>
        </ul>
      </div>
    </header>
    <div class="body flex-grow-1 px-3">
      <div class="container-lg">
        <div class="card mb-4">
          <div class="card-body">
            <div class="row mb-2" id="produkContainer">
              <div class="col-2">
                <button class="btn btn-primary btn-block w-100" id="btnPilihProduk" data-coreui-toggle="modal"
                  data-coreui-target="#produkModal">Pilih Produk</button>
              </div>
              <div class="col-3">
                <input type="text" class="form-control" placeholder="Kode Produk" readonly name="kode">
              </div>
              <div class="col-3">
                <input type="text" class="form-control" placeholder="Nama Produk" readonly name="nama">
              </div>
              <div class="col-3">
                <input type="number" class="form-control" placeholder="Jumlah Produk" name="jumlah" id="jumlahProduk">
              </div>
            </div>

            <div class="row" id="bahanContainer">
              <div class="col-2">
                <button class="btn btn-info btn-block w-100 text-white" id="btnPilihBahan">Pilih Bahan</button>
              </div>
              <div class="col-3">
                <input type="text" class="form-control" placeholder="Kode Bahan" readonly name="kode">
              </div>
              <div class="col-3">
                <input type="text" class="form-control" placeholder="Nama Bahan" readonly name="nama">
              </div>
              <div class="col-3">
                <input type="number" class="form-control" placeholder="Jumlah Bahan" name="jumlah">
              </div>
              <div class="col-1">
                <button class="btn btn-danger btn-block w-100 text-white" id="btnAddBahan">+</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card mb-2">
          <div class="card-body">
            <table id="selectedBahanTable" class="display" style="width:100%">
              <thead>
                <tr>
                  <th>Kode Bahan</th>
                  <th>Nama Bahan</th>
                  <th>Jumlah</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <button class="btn btn-primary" id="btnProses">Proses</button>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div><a href="https://coreui.io">CoreUI </a><a href="https://coreui.io">Bootstrap Admin Template</a> Â© 2023
        creativeLabs.</div>
      <div class="ms-auto">Powered by&nbsp;<a href="https://coreui.io/docs/">CoreUI UI Components</a></div>
    </footer>
  </div>

  <!-- Modals -->
  <div class="modal fade" id="produkModal" tabindex="-1" role="dialog" aria-labelledby="produkModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="produkModalLabel">Pilih Produk</h5>
          <button type="button" class="close" data-coreui-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="d-flex justify-content-end mb-2">
            <button class="btn btn-primary" data-coreui-toggle="modal" data-coreui-target="#tambahProdukModal">Tambah
              Produk</button>
          </div>

          <table id="produkTable" class="display" style="width:100%">
            <thead>
              <tr>
                <th>Kode Produk</th>
                <th>Nama Produk</th>
                <th>Stok</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody>

            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-coreui-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="bahanModal" tabindex="-1" role="dialog" aria-labelledby="bahanModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bahanModalLabel">Pilih Bahan</h5>
          <button type="button" class="close" data-coreui-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <table id="bahanTable" class="display" style="width:100%">
            <thead>
              <tr>
                <th>Kode Bahan</th>
                <th>Nama Bahan</th>
                <th>Stok</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody>

            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-coreui-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="tambahProdukModal" tabindex="-1" role="dialog" aria-labelledby="tambahProdukModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <form>
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="tambahProdukModalLabel">Tambah Produk</h5>
            <button type="button" class="close" data-coreui-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="add_product_name">Nama Produk</label>
                <input type="text" class="form-control" placeholder="Nama Produk" name="product_name"
                  id="add_product_name">
              </div>
              <div class="col-md-6 mb-3">
                <label for="add_category_id">Kategori</label>
                <select class="form-control" name="category_id" id="add_category_id">
                  <option value="">-- Pilih Kategori --</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="add_quantity">Stok</label>
                <input type="number" class="form-control" placeholder="Stok" name="quantity" id="add_quantity">
              </div>

              <div class="col-md-6 mb-3">
                <label for="add_price">Harga</label>
                <input type="number" class="form-control" placeholder="Harga" name="price" id="add_price">
              </div>
            </div>

            <div class="row">
              <div class="col mb-3">
                <label for="add_description">Deskripsi</label>
                <textarea class="form-control" placeholder="Deskripsi" name="description"
                  id="add_description"></textarea>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-coreui-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="btnTambahProduk">Tambah</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="prosesModal" tabindex="-1" role="dialog" aria-labelledby="prosesModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="prosesModalLabel">Proses Berhasil</h5>
          <button type="button" class="close" data-coreui-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Produk beserta bahan yang dibutuhkan telah berhasil diproses
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-coreui-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CoreUI and necessary plugins-->
  <script src="vendors/@coreui/coreui/js/coreui.bundle.min.js"></script>
  <script src="vendors/simplebar/js/simplebar.min.js"></script>

  <script>
    // Data
    let produk = []
    let bahan = []
    let selectedProduk = null
    let selectedBahan = null
    let selectedBahanList = []
    let categories = []

    // Elements
    let produkTable = null
    let bahanTable = null
    let selectedBahanTable = null
    let produkContainer = null
    let bahanContainer = null
    let btnPilihProduk = null
    let btnPilihBahan = null
    let btnAddBahan = null

    // Datatables
    let produkDatatable = null
    let bahanDatatable = null
    let selectedBahanDatatable = null

    function init() {
      produkTable = $('#produkTable')
      bahanTable = $('#bahanTable')
      selectedBahanTable = $('#selectedBahanTable')
      produkContainer = $('#produkContainer')
      bahanContainer = $('#bahanContainer')
      btnPilihProduk = $('#btnPilihProduk')
      btnPilihBahan = $('#btnPilihBahan')
      btnAddBahan = $('#btnAddBahan')

      produkDatatable = produkTable.DataTable()
      bahanDatatable = bahanTable.DataTable()
      selectedBahanDatatable = selectedBahanTable.DataTable()

      fetchProduk()
      fetchBahan()
      fetchKategori()
    }

    // Fetchings
    function fetchProduk() {
      $.ajax({
        url: 'https://tugas-16.rizalord.xyz/api/v2/products',
        method: 'GET',
        success: function ({ data }) {
          produkDatatable.clear()

          data = data.map((item) => ({
            kode: item.product_id,
            nama: item.product_name,
            jumlah: item.quantity
          }))

          data.forEach((item) => {
            produk.push(item)

            produkDatatable.row.add([
              item.kode,
              item.nama,
              item.jumlah,
              `<div>
                  <button class="btn btn-primary mr-2" onclick="selectProduk('${item.kode}')">Pilih</button>
                  <button class="btn btn-danger text-white" onclick="removeProduk('${item.kode}')">Hapus</button>
              </div>`
            ])
          })

          produkDatatable.draw()
        }
      })
    }

    function fetchBahan() {
      $.ajax({
        url: window.location.origin + window.location.pathname + '/data/bahan.json',
        method: 'GET',
        success: function ({ data }) {
          bahanDatatable.clear()

          data.forEach((item) => {
            bahan.push(item)

            bahanDatatable.row.add([
              item.kode,
              item.nama,
              item.jumlah,
              `<button class="btn btn-primary" onclick="selectBahan('${item.kode}')">Pilih</button>`
            ])
          })

          bahanDatatable.draw()
        }
      })
    }

    function fetchProdukBahan(kode) {
      let tempBahan = []

      $.ajax({
        url: `https://tugas-16.rizalord.xyz/api/v2/products/${kode}/ingredients`,
        method: 'GET',
        async: false,
        success: function ({ data }) {
          produkDatatable.clear()

          tempBahan = data.map((item) => ({
            kode: item.kode,
            nama: item.nama,
            jumlah: item.qty
          }))

          tempBahan = tempBahan.filter((item) => bahan.find((bahanItem) => bahanItem.kode === item.kode))
        }
      })

      return tempBahan
    }

    function fetchKategori() {
      $.ajax({
        url: 'https://tugas-16.rizalord.xyz/api/v2/categories',
        method: 'GET',
        success: function ({ data }) {
          categories = data

          categories.forEach((item) => {
            $('#add_category_id').append(`<option value="${item.category_id}">${item.category_name}</option>`)
          })
        }
      })
    }

    // Events
    $('#btnPilihBahan').click(function () {
      if (!selectedProduk) {
        return alert('Pilih produk terlebih dahulu')
      }

      $('#bahanModal').modal('show')
    })

    $('#btnAddBahan').click(function () {
      if (!selectedBahan) {
        return alert('Pilih bahan terlebih dahulu')
      }

      const jumlah = bahanContainer.find('input[name="jumlah"]').val()

      if (!jumlah) {
        return alert('Masukkan jumlah bahan terlebih dahulu')
      }

      if (jumlah > selectedBahan.jumlah) {
        return alert('Jumlah bahan melebihi stok')
      }

      const tempSelectedBahan = {
        ...selectedBahan,
        jumlah: parseInt(jumlah)
      }

      selectedBahanList.push(tempSelectedBahan)

      selectedBahanDatatable.row.add([
        tempSelectedBahan.kode,
        tempSelectedBahan.nama,
        tempSelectedBahan.jumlah,
        `<button class="btn btn-danger text-white" onclick="removeBahan('${tempSelectedBahan.kode}')">Hapus</button>`
      ])

      selectedBahanDatatable.draw()

      bahanContainer.find('input').each(function (index, item) {
        const input = $(item)
        const name = input.attr('name')

        input.val('')
      })

      selectedBahan = null
    })

    $('#btnProses').click(function () {
      if (!selectedProduk) {
        return alert('Pilih produk terlebih dahulu')
      }

      if (selectedProduk.jumlah < $('#jumlahProduk').val()) {
        return alert('Jumlah produk melebihi stok')
      }

      if (selectedBahanList.length === 0) {
        return alert('Pilih bahan terlebih dahulu')
      }

      $.ajax({
        url: `https://tugas-16.rizalord.xyz/api/v2/products/${selectedProduk.kode}/ingredients`,
        method: 'POST',
        async: false,
        data: {
          data: selectedBahanList.map((item) => ({
            kode: item.kode,
            nama: item.nama,
            qty: item.jumlah
          }))
        },
        success: function ({ data }) {
          $('#prosesModal').modal('show')
        },
        error: function (err) {
          alert('Terjadi kesalahan dalam memproses data')
        }
      })
    })

    $('#btnTambahProduk').click(function () {
      const nama = $('#add_product_name').val()
      const kategori = $('#add_category_id').val()
      const stok = $('#add_quantity').val()
      const harga = $('#add_price').val()
      const deskripsi = $('#add_description').val()

      if (!nama) {
        return alert('Masukkan nama produk terlebih dahulu')
      }

      if (!kategori) {
        return alert('Pilih kategori terlebih dahulu')
      }

      if (!stok) {
        return alert('Masukkan stok terlebih dahulu')
      }

      if (!harga) {
        return alert('Masukkan harga terlebih dahulu')
      }

      if (!deskripsi) {
        return alert('Masukkan deskripsi terlebih dahulu')
      }

      const formData = new FormData()
      formData.append('product_name', nama)
      formData.append('category_id', kategori)
      formData.append('quantity', stok)
      formData.append('price', harga)
      formData.append('description', deskripsi)

      $.ajax({
        url: 'https://tugas-16.rizalord.xyz/api/v2/products',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function ({ data }) {
          $('#tambahProdukModal').modal('hide')

          alert('Produk berhasil ditambahkan')

          fetchProduk()
        },
        error: function (err) {
          alert('Terjadi kesalahan dalam menambahkan produk')
        }
      })
    })

    // On Select and Remove
    function selectProduk(kode) {
      const tempSelectedProduk = produk.find((item) => item.kode === kode)

      produkContainer.find('input').each(function (index, item) {
        const input = $(item)
        const name = input.attr('name')

        input.val(tempSelectedProduk[name])
      })

      if (selectedProduk != tempSelectedProduk) {
        selectedBahanList.forEach(() => selectedBahanList.pop())
        selectedBahanDatatable.clear()

        let bahan = fetchProdukBahan(kode)

        bahan.forEach((item) => {
          selectedBahanList.push(item)

          selectedBahanDatatable.row.add([
            item.kode,
            item.nama,
            item.jumlah,
            `<button class="btn btn-danger text-white" onclick="removeBahan('${item.kode}')">Hapus</button>`
          ])
        })

        selectedBahanDatatable.draw()
      }

      selectedProduk = tempSelectedProduk

      $('#produkModal').modal('hide')
    }

    function selectBahan(kode) {
      if (!selectedProduk) {
        return alert('Pilih produk terlebih dahulu')
      }

      const tempSelectedBahan = bahan.find((item) => item.kode === kode)

      if (selectedBahanList.find((item) => item.kode === kode)) {
        return alert('Bahan sudah dipilih')
      }

      bahanContainer.find('input').each(function (index, item) {
        const input = $(item)
        const name = input.attr('name')

        input.val(tempSelectedBahan[name])
      })

      selectedBahan = tempSelectedBahan

      $('#bahanModal').modal('hide')
    }

    function removeBahan(kode) {
      const tempSelectedBahan = selectedBahanList.find((item) => item.kode === kode)

      selectedBahanList.splice(selectedBahanList.indexOf(tempSelectedBahan), 1)

      selectedBahanDatatable.clear()

      selectedBahanList.forEach((item) => {
        selectedBahanDatatable.row.add([
          item.kode,
          item.nama,
          item.jumlah,
          `<button class="btn btn-danger text-white" onclick="removeBahan('${item.kode}')">Hapus</button>`
        ])
      })

      selectedBahanDatatable.draw()
    }

    function removeProduk(kode) {
      const tempSelectedProduk = produk.find((item) => item.kode === kode)

      const konfirmasi = confirm('Apakah anda yakin ingin menghapus produk ini?')

      if (!konfirmasi) {
        return
      }

      $.ajax({
        url: `https://tugas-16.rizalord.xyz/api/v2/products/${kode}`,
        method: 'DELETE',
        success: function ({ data }) {
          alert('Produk berhasil dihapus')

          if (tempSelectedProduk === selectedProduk) {
            selectedProduk = null

            produkContainer.find('input').each(function (index, item) {
              const input = $(item)
              const name = input.attr('name')

              input.val('')
            })

            selectedBahanList.forEach(() => selectedBahanList.pop())
            selectedBahanDatatable.clear()
            selectedBahanDatatable.draw()
          }

          fetchProduk()
        },
        error: function (err) {
          alert('Terjadi kesalahan dalam menghapus produk')
        }
      })
    }
    
    $(document).ready(function () {
      init()
    });
  </script>


</body>

</html>